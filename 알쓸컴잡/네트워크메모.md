# 5장 3계층

1. 라우터와 L3스위치는 현대에는 구분하기 거의 어렵다.
2. 스위치와 반대로 라우터는 들어온 패킷의 목적지 주소가 라우팅 테이블에 없으면 패킷을 버림
3. 기존 2계층 헤더 정보를 제거 후 새로운 2계층 헤더 정보를 붙인다.

### 경로 지정(라우팅) - 핵심 역할

1. ip주소를 기반으로 적절한 경로로 패킷을 포워딩한다
2. 경로 지정은 두 가지 스텝으로 나뉜다.

- 경로 정보를 얻는다.
  1. 인접 네트워크의 정보를 얻는 방식
  2. 관리자가 직접 경로 정보를 입력하는 방식
  3. 라우터끼리 서로 경로 정보를 자동으로 교환
- 얻는 경로 정보를 확인하고 패킷을 포워딩한다.

3. 라우터는 exact match가 아니더라도 가장 근접하다고 판단되는 경로(넥스트 홉)로 패킷을 포워딩한다.
4. 네트워크를 한 단계씩 건너뛴다는 의미로 홉 바이 홉으로 표현한다.
5.

### 브로드캐스트 컨트롤

1. 라우터는 멀티캐스트 정보를 습득하지 않고, 브로드캐스트 패킷을 전달하지 않는다. 이를 두고 브로드캐스트/멀티캐스트 컨트롤이라고 부른다. 다른 네트워크에 브로드캐스트가 전파되지 않도록 한다.
2. 위의 원리를 활용해 브로드캐스트가 많이 발생하는 네트워크의 경우 네트워크를 분할해 브로드캐스트로 인한 부하를 줄일 수 있다.
3.

### 프로토콜 변환

1. 현대 네트워크는 이더넷으로 수렴되므로 이 역할은 많이 축소되었음
2. 과거에 LAN이 WAN기술로 변환되어야했는데, 이 역할을 라우터가 담당했음

- 3계층 헤더 정보를 확인하기 위해 2계층까지 벗겨내고, 3계층 주소를 확인한 후 2계층 헤더 정보를 새로 만들어 내보낸다.
- 이를 이용해 서로 다른 프로토콜간 중재가 가능해진다. 어떤 프로토콜을 사용해 통신할지를 새로 정의해서 보낼 수 있으니까

# 6장 4계층

1. 포트(프로세스의) 번호, 시퀀스 번호, ACK 번호 등이 속한다.
2. 통신의 방향성, 순서와 같은 통신 전반에 대한 관리
3. 2번과 같은 정보들을 세션테이블에 보관하여 컨트롤하며, 4계층 이상에서 동작하는 장비들은 세션 테이블을 가진다.
4. 로드 밸런서, 방화벽과 같은 장비를 세션장비라고 부르기도 한다.
5. 세션 장비의 최우선 고려사항 3요소
   a. 세션 테이블
   b. symmetric(대칭) 경로 요구
   c. 정보 벼경(로드 밸런서의 경우 IP주소와 L7로드밸런서의 애플리케이션 프로토콜 정보 변경 등)

### 로드 밸런서

1. 4계층 이상에서 동작
2. 로드 밸런서는 웹이나 어플리케이션 뿐 아니라, FWLB(방화벽 로드밸런싱), VPNLB(VPN 로드밸런싱) 등 다양한 서비스를 위해 사용가능하다.
3. L4와 L7에서 동작하며, 현대의 로드밸런서는 보통 L4와 L7을 모두 지원한다. 4계층 정보만 가지고 로드밸런싱하면 4계층 로드밸런싱이라고 불리는 것 뿐이다. TCP, UDP 정보를 기반으로 동작하며, 특히 포트번호가 주로 사용된다.
4. L7 로드밸런싱은 애플리케이션 프로토콜 정보를 기반으로 동작하며, 이런 장비를 ADC(application delivery controller)라고 부른다. 프록시의 역할을 수행할 수 있고, Nginx의 리버스 프록시와 유사한 동작을 한다.

### L4 스위치

1. 로드 밸런싱 기능이 있는 스위치를 이른다.
2. 재부 동작은 4계층 로드 밸런서이지만, 외형은 스위치와 같이 여러개의 포트를 지닌다.
3. 부하분산, 성능 최적화, 리다이렉션을 제공한다.
4. 가상 서버, 가상 IP, 리얼 서버, 리얼 IP를 가지고 있는데, 사용자는 가상 IP를 바라보고 서비스를 이용하고 L4스위치는 요청을 받아 리얼 IP로 보내 서비스를 수행한다.

### ADC

1. 애플리케이션 계층에서 동작하는 로드밸런서
2. 대부분의 ADC는 L4스위치의 기능을 포함한다.
3. 온갖 동작이 가능하다. failover, 리다이렉션, 캐싱, 압축, 콘텐츠 변환, 인코딩 변환, WAF, HTML, XML 검증 및 변환을 수행할 수 있다.

### L4스위치 vs ADC

1. L4스위치는 4계층 정보만을 이용해 DoS를 어느정도 방어 할 수 있고, TCP 세션 재사용과 같은 보안 및 성능을 높여주는 기능도 수행할 수 있다.
2. ADC에서 웹서버 대신 압축을 수행해 부하를 낮출 수 있다. 하드웨어 가속 등 성능 최적화를 위한 ADC의 솔루션은 다양하다.
3. ADC에는 SSL 가속 카드가 내장되어 있는 경우가 많다. 리버스 프록시처럼 웹서버와의 통신은 일반 HTTP로, 외부통신은 자신이 HTTPS로 수행해 부하를 낮춰주기 위함이다.

### 방화벽

1. 트래픽을 사전에 정해진 정책에 따라 허용하거나 차단하는 장비
2. 일반적으로 3,4계층에서 동작하고 세션을 인지, 관리하는 SPI(Stateful Packet Inspection)엔진을 기반으로 동작하는 장비를 방화벽이라고 부르지만, 네트워크에서 보안을 제공하는 모든 장비를 방화벽이라고 부르기도 한다.
3. 방화벽은 NAT와 유사하게 세션 정보를 장비 내부에 저장한다. 세션 정보는 패킷이 외부로 나갈 때 저장되는데, 이를 통해 패킷의 입출력시 외부에서 출발한 패킷인지, 내부에서 출발한 것인지 가려낼 수 있다.
4. 방화벽의 기본정책은 나가는 모든 패킷을 허용하고, 외부의 모든 패킷을 차단하는 것이다. 세션 테이블의 존재로 세션의 방향성을 파악하는 것만으로도 복잡도를 많이 줄일 수 있다.

### 4계층 장비 통과의 유의점

#### 세션만료

1. A와 B사이에 세션이 연결된다. A와 B사이에는 세션테이블이 있는 장비가 있다고 가정하자. 그 장비의 세션테이블 값이 만료(세션 테이블은 메모리에 적재되므로 무한대로 저장할 수 없다. 만료시키던, 회전시키던 해야한다)된 후에 A와 B간의 통신이 시작되었다고 생각해보자.
2. 이 때, A와 B는 통신할 수 없게 된다. 세션 테이블에 정보가 없는데 뜬금없이 ACK패킷이 들어왔기 때문이다. 각종 설정을 통해 강제로 통과시키게 할 수 있지만, 이런 식의 해결은 보안에 취약하며 의도된 사용법도 아니다.
3. 세션 장비의 타임아웃 시간을 애플리케이션에 맞게 설정하는 방법도 있고, 포트번호나 IP주소마다 별도의 세션 만료시간을 설정할 수도 있다.
4. 세션 테이블에서 세션이 만료될 때마다 양측 통신 당사자에게 세션 종료를 통보할 수도 있다.
5. 소프트웨어 개발자 입장에서는, 더미 패킷을 주기적으로 보내 세션 테이블에서 삭제되는 것을 막는 방법이 있다. 이는 매우 흔하게 사용되는 방법이다.

#### 비대칭 경로

1. 인바운드 패킷과 아웃바운드 패킷이 같은 장비를 통과하는 것을 대칭 경로, 다른 장비를 통과하는 것을 비대칭 경로라고 한다.
2. 세션 장비는 상술했듯 세션 테이블이 있기 때문에 비대칭 경로로 통신하면 문제가 생긴다.
3. 비대칭 경로가 생기더라도 해결할 수 있다(네트워크의 효율성 등을 고려해 비대칭으로 설계하기도 한다).
4. 첫 번째 방법은 각 장비의 세션테이블을 동기화 시키는 것이다.
5. 두 번째 방법은 아웃바운드 기록이 없는데 인바운드 패킷이 도착한 경우 동일한 수준에 있는 다른 세션 장비로 패킷을 포워딩해서 처리하는 것이다. 다른 장비에는 그 패킷의 아웃바운드 정보가 있으므로 통신이 가능해진다.

#### 하나의 통신에 복수의 세션

1. 하나의 통신을 위해 하나의 세션이 사용되는 경우가 대부분이지만, 특별한 목적으로 복수의 세션을 사용하기도 한다.
2. FTP는 컨트롤 프로토콜과 데이터 프로토콜이 완전히 분리되어 있다. 오래된 프로토콜이라서 그렇다.
3.
