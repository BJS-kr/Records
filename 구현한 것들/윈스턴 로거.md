# Nest 기반 Winston 로거
@nestjs/common에서 제공하는 LoggerService interface를 implements하여 제작했고, winston을 사용한 로거입니다.
warn레벨 이상의 로그와 debug레벨 이상의 로그를 저장하는 daily rotate file을 각각 생성하고, warn 레벨 이상의 로그 발생시 저장뿐 아니라 슬랙에 메세지를 보냅니다.

```javascript
import * as winston from 'winston';
import * as DailyRotateFile from 'winston-daily-rotate-file';
import * as SlackHook from 'winston-slack-webhook-transport';
import * as moment from 'moment';
import { LoggerService } from '@nestjs/common';
import { hostname } from 'os';
import { NodeEnv } from '../types';
import { ErrorCodes } from '../consts';

/**
* 참고한 문서들
* https://github.com/winstonjs/winston
* https://www.npmjs.com/package/winston-slack-webhook-transport
* https://github.com/winstonjs/winston-daily-rotate-file
* https://stackoverflow.com/questions/9380785/node-js-winston-can-i-add-default-meta-data-to-all-log-messages
* https://stackoverflow.com/questions/42858585/add-module-name-in-winston-log-entries
*/

const errorKeys = Object.keys(ErrorCodes);
const findKey = (ErrorCodes, errorKeys, code) => {
  return errorKeys.find(key => ErrorCodes[key] === code);
};
const { combine, printf, label, timestamp } = winston.format;
const myFormat = printf(
  ({
    level,
    message,
    label,
    timestamp,
    exception,
    code,
    context,
    hostname,
    PID,
    callstack,
  }) => {
    if (level === 'error' || level === 'warn') {
      return `${hostname}(${PID}) ${timestamp} [${label}] ${level} ${context}: ${exception} ${message} Code: ${code}(${findKey(
        ErrorCodes,
        errorKeys,
        code,
      )})\n Call stack: ${callstack}`;
    } else {
      return `${hostname}(${PID}) ${timestamp} [${label}] ${level} ${context}: ${message}`;
    }
  },
);

const slackMessageFormat = error => `
Server: ${error.hostname || ':warning: Unknown Server :warning:'}
PID: ${error.PID || ':warning: Unknown PID :warning:'}
When: ${'`'}${moment(new Date()).format('YYYY-MM-DD (HH:MM:s)')}${'`'}
Level: ${error.level === 'error' ? '*ERROR*' : '*WARN*'}
Code: ${error.code || ':warning: Unknown error code :warning:'} (${findKey(
  ErrorCodes,
  errorKeys,
  error.code,
) || ':warning: Unknown Error name :warning:'})
Message: ${
  JSON.stringify(error.message) === '{}'
    ? ':warning: Unknown message :warning:'
    : error.message
}
Stack: ${
  error.callstack
    ? error.callstack
        .split('\n')
        .map((cur, i) => {
          if (i === 0) {
            return '';
          }
          return cur;
        })
        .join('\n')
    : ':warning: Unknown callstack :warning:'
}`;

const addContextNameFormatAndPIDAndHostname = winston.format(log => {
      log.context = name;
      log.PID = process.pid;
      log.hostname = hostname();
      return log;
});

export class WinstonLogger implements LoggerService {
  private logger: winston.Logger;
  constructor(name: string, NODE_ENV: NodeEnv) {
    this.logger = winston.createLogger({
      level: 'debug',
      format: combine(
        label({ label: 'TTV' }),
        addContextNameFormatAndPIDAndHostname(),
        timestamp({ format: 'YYYY-MM-DD (HH:MM:s)' }),
        myFormat,
      ),
      defaultMeta: { context: name },
      transports: [
        new DailyRotateFile({
          filename: '%DATE%-error.log',
          datePattern: 'YYYY-MM-DD',
          level: 'warn',
          dirname: './log',
          maxFiles: 30,
        }).on('logRemoved', removedFilename => {
          console.log(
            "Day before 30 days's Error Log file was removed, Filename:" +
              removedFilename,
          );
        }),
        new DailyRotateFile({
          filename: '%DATE%-combined.log',
          datePattern: 'YYYY-MM-DD',
          level: 'debug',
          zippedArchive: true,
          dirname: './log',
          maxSize: '100m',
          maxFiles: 365,
        }),
        new SlackHook({
          webhookUrl:
            // your webhook URL,
          level: 'warn',
          name: 'Waynehills-Dev-Team',
          formatter: error => {
            return {
              blocks: [
                {
                  type: 'section',
                  text: {
                    type: 'mrkdwn',
                    text:
                      ':blobhelp: *' +
                      (error.exception || 'Unknown Exception') +
                      '!* :blobhelp:',
                  },
                },
                {
                  type: 'section',
                  text: {
                    type: 'mrkdwn',
                    text: slackMessageFormat(error),
                  },
                },
              ],
            };
          },
        }),
      ],
    });

    if (NODE_ENV !== 'production') {
      this.logger.add(
        new winston.transports.Console({
          format: winston.format.simple(),
        }),
      );
    }
  }

  error(error: any, code: ErrorCodes) {
    this.logger.error({
      exception: error.name,
      code,
      message: error.message,
      callstack: error.stack,
    });
    throw error;
  }

  warn(error: any, code: ErrorCodes) {
    this.logger.error({
      exception: error.name,
      code,
      message: error.message,
      callstack: error.stack,
    });
    throw error;
  }

  log(level: string, message: any) {
    return this.logger.log(level, message);
  }

  debug(message: string) {
    return this.logger.debug(message);
  }
}
```
